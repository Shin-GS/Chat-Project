<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="en"
      th:lang="${#locale.toLanguageTag()}">
<body>
<div th:fragment="conversation-list"
     class="flex flex-col min-h-0 h-full"
     id="sidebar-secondary-content"
     hx-swap-oob="true">
    <div hidden="hidden"
         id="refresh-conversation-list"
         hx-trigger="refresh:refresh-conversation-list from:body"
         hx-get="/hx/conversations"
         hx-swap="none"></div>

    <ul class="divide-y divide-gray-200 text-sm sm:text-base max-h-64 lg:max-h-[60vh] overflow-y-auto pr-1">
        <!--/*@thymesVar id="conversations" type="java.util.List<com.chat.server.service.conversation.response.ConversationInfoAndMessageResponse>"*/-->
        <!--/*@thymesVar id="conversation"  type="com.chat.server.service.conversation.response.ConversationInfoAndMessageResponse>"*/-->
        <li th:if="${#lists.isEmpty(conversations)}"
            class="py-4 text-center text-gray-500"
            th:text="#{ui.conversation_list.empty}">
            No conversations yet
        </li>

        <li th:each="conversation : ${conversations}"
            class="py-2 px-2 sm:px-3 flex items-start gap-3 hover:bg-gray-50 transition-colors"
            th:attr="hx-get='/hx/conversations/' + ${conversation.id} + '/panel'"
            hx-swap="none">

            <!-- LEFT: avatar image if exists; otherwise type badge -->
            <div class="shrink-0 self-start sm:self-center">

                <!-- ONE_TO_ONE: avatar is clickable -> open friend profile modal -->
                <div th:if="${conversation.type.name() == 'ONE_TO_ONE'}"
                     class="cursor-pointer"
                     th:attr="hx-get='/hx/conversations/friends/' + ${conversation.friendUserId} + '/profile/modal'"
                     hx-swap="none"
                     onclick="event.stopPropagation()">
                    <!-- Show conversation image when available -->
                    <img th:if="${conversation.imageUrl != null and !#strings.isEmpty(conversation.imageUrl)}"
                         th:src="${conversation.imageUrl}"
                         alt="Conversation avatar"
                         loading="lazy"
                         decoding="async"
                         class="w-7 h-7 rounded-full object-cover border border-gray-200"/>

                    <!-- Fallback: user badge when no image -->
                    <span th:if="${conversation.imageUrl == null or #strings.isEmpty(conversation.imageUrl)}"
                          class="inline-flex items-center justify-center rounded-full w-7 h-7 border shrink-0 bg-blue-50 text-blue-700 border-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M15.75 7.5a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a7.5 7.5 0 0115 0v.75H4.5v-.75z"/>
                        </svg>
                    </span>
                </div>

                <!-- GROUP: avatar is clickable -> open group profile modal -->
                <div th:if="${conversation.type.name() == 'GROUP'}"
                     class="cursor-pointer"
                     th:attr="hx-get='/hx/conversations/groups/' + ${conversation.id} + '/profile/modal'"
                     hx-swap="none"
                     onclick="event.stopPropagation()">
                    <!-- Show conversation image when available -->
                    <img th:if="${conversation.imageUrl != null and !#strings.isEmpty(conversation.imageUrl)}"
                         th:src="${conversation.imageUrl}"
                         alt="Group avatar"
                         loading="lazy"
                         decoding="async"
                         class="w-7 h-7 rounded-full object-cover border border-gray-200"/>

                    <!-- Fallback: group badge when no image -->
                    <span th:if="${conversation.imageUrl == null or #strings.isEmpty(conversation.imageUrl)}"
                          class="inline-flex items-center justify-center rounded-full w-7 h-7 border shrink-0 bg-purple-50 text-purple-700 border-purple-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M15 19.128v-.378a4.5 4.5 0 00-4.5-4.5h-3a4.5 4.5 0 00-4.5 4.5v.378m12 0v-.378a4.5 4.5 0 014.5-4.5h-3a4.5 4.5 0 014.5 4.5v.378m0 0V21m0-1.872V21m-6-8.25a3 3 0 100-6 3 3 0 000 6z"/>
                        </svg>
                    </span>
                </div>

                <!-- OTHER (neither ONE_TO_ONE nor GROUP): not clickable for profile -->
                <div th:if="${conversation.type.name() != 'ONE_TO_ONE' and conversation.type.name() != 'GROUP'}">
                    <!-- Show conversation image when available -->
                    <img th:if="${conversation.imageUrl != null and !#strings.isEmpty(conversation.imageUrl)}"
                         th:src="${conversation.imageUrl}"
                         alt="Conversation avatar"
                         loading="lazy"
                         decoding="async"
                         class="w-7 h-7 rounded-full object-cover border border-gray-200"/>

                    <!-- Fallback: type badge when no image -->
                    <span th:if="${conversation.imageUrl == null or #strings.isEmpty(conversation.imageUrl)}"
                          class="inline-flex items-center justify-center rounded-full w-7 h-7 border shrink-0 bg-gray-100 text-gray-700 border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M7.5 8.25h9m-9 3h9m-9 3h6M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4.223-.923L3 20.25l1.223-4.223A8.964 8.964 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </span>
                </div>
            </div>

            <!-- RIGHT: 2-row layout -->
            <div class="flex flex-col flex-1 min-w-0">

                <!-- First row: title + time + (read checks) -->
                <div class="flex items-center gap-2">
                    <div class="flex-1 min-w-0"
                         th:replace="~{components/conversation/read :: title(${conversation})}">
                        <!-- fallback -->
                        <span class="flex-1 min-w-0 truncate font-semibold text-gray-900 text-[15px] sm:text-base"
                              th:text="#{ui.conversation_list.untitled}">
                            Untitled conversation
                        </span>
                    </div>

                    <div class="flex items-center gap-1">
                        <div class="text-[11px] sm:text-xs text-gray-400 whitespace-nowrap tabular-nums shrink-0">
                            <span th:with="
                                    now=${#temporals.createNow()},
                                    target=${conversation.lastActivityAt},
                                    isToday=${#temporals.day(now) == #temporals.day(target) and #temporals.month(now) == #temporals.month(target) and #temporals.year(now) == #temporals.year(target)},
                                    yesterday=${now.minusDays(1)},
                                    isYesterday=${#temporals.day(yesterday) == #temporals.day(target) and #temporals.month(yesterday) == #temporals.month(target) and #temporals.year(yesterday) == #temporals.year(target)},
                                    sameYear=${#temporals.year(now) == #temporals.year(target)}
                                 ">
                                <span th:if="${isToday}" th:text="${#temporals.format(target, 'HH:mm')}">14:35</span>
                                <span th:if="${!isToday and isYesterday}"
                                      th:text="#{ui.conversation_list.yesterday}">Yesterday</span>
                                <span th:if="${!isToday and !isYesterday and sameYear}"
                                      th:text="${#temporals.format(target, 'MMM d')}">Aug 25</span>
                                <span th:if="${!isToday and !isYesterday and !sameYear}"
                                      th:text="${#temporals.format(target, 'yy MMM d')}">25 Aug 25</span>
                            </span>
                        </div>

                        <div th:replace="~{components/conversation/read :: read-check(${conversation})}">
                            <!-- fallback empty -->
                        </div>
                    </div>
                </div>

                <!-- Second row: last message + unread badge + leave -->
                <div class="flex items-center gap-2 mt-0.5">
                    <span th:text="${conversation.lastMessage}"
                          class="flex-1 min-w-0 truncate text-gray-600 text-[13px] sm:text[14px] leading-snug"
                          th:classappend="${conversation.lastMessage != null and conversation.lastMessage != '' and !conversation.read} ? ' text-gray-900 font-medium' : ''">
                        [[#{ui.conversation_list.last_message_placeholder}]]
                    </span>

                    <span th:replace="~{components/conversation/read :: unread-dot(${conversation})}">
                        <!-- fallback empty -->
                    </span>

                    <button type="button"
                            class="shrink-0 inline-flex items-center justify-center rounded-full border border-red-200 bg-red-50 text-red-600 hover:bg-red-100 px-2 sm:px-3 py-1 text-[11px] sm:text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-red-400/40 transition"
                            th:attr="hx-post='/hx/conversations/' + ${conversation.id} + '/leave', hx-confirm=#{confirm.leave_conversation}"
                            hx-swap="none"
                            th:text="#{button.leave}">
                        Leave
                    </button>
                </div>
            </div>
        </li>
    </ul>
</div>
</body>
</html>
