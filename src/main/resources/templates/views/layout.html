<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="en"
      th:lang="${#locale.toLanguageTag()}">
<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link href="/css/globals.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="/script/htmx.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('htmx:afterRequest', (event) => {
                const container = document.querySelector('#toast-container');
                if (container) {
                    setTimeout(() => {
                        [...container.children].forEach(child => child.classList.add('opacity-0'));
                        setTimeout(() => {
                            while (container.firstChild) {
                                container.removeChild(container.firstChild);
                            }
                        }, 300);
                    }, 2500);
                }

                const reloadHeader = event.detail?.xhr?.getResponseHeader("HX-RELOAD");
                if (reloadHeader === "true") {
                    window.location.reload();
                }

                const redirectHeader = event.detail?.xhr?.getResponseHeader('HX-REDIRECT');
                if (redirectHeader) {
                    const target = redirectHeader.trim();
                    try {
                        let urlString;

                        // Absolute external URL
                        if (/^https?:\/\//i.test(target)) {
                            urlString = target;
                        }

                        // Protocol-relative URL -> prefix current protocol
                        else if (/^\/\//.test(target)) {
                            urlString = window.location.protocol + target;
                        }

                        // Root-relative path on current origin
                        else if (target.startsWith('/')) {
                            urlString = window.location.origin + target;
                        }

                        // Relative path -> resolve against current URL
                        else {
                            urlString = new URL(target, window.location.href).toString();
                        }

                        window.location.assign(urlString); // Perform the redirect

                    } catch (e) {
                        console.error('Invalid HX-REDIRECT value:', redirectHeader, e);
                    }
                }
            });
        });
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
<header th:fragment="header">
    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <!-- Top bar with language selector -->
    <div class="w-full bg-white/80 backdrop-blur border-b border-gray-200">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
            <div class="text-sm sm:text-base font-semibold text-gray-800">
                <!-- App title or logo area -->
                <a href="/" class="hover:opacity-80 transition" th:text="#{app.title}">Chat App</a>
            </div>

            <!-- Language selector -->
            <div class="flex items-center gap-2">
                <label for="lang-select" class="sr-only" th:text="#{aria.select_language}">Select language</label>
                <select id="lang-select"
                        name="lang"
                        class="block rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm sm:text-base text-gray-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300"
                        hx-post="/hx/common/locale"
                        hx-trigger="change"
                        hx-headers='{"Accept":"application/json"}'>
                    <option th:each="loc : ${T(com.chat.server.common.constant.SupportedLocale).values()}"
                            th:value="${loc.code}"
                            th:text="${loc.label}"
                            th:selected="${#locale.toLanguageTag() == loc.code}">
                    </option>
                </select>
            </div>
        </div>
    </div>
</header>

<main class="flex-grow container mx-auto px-4 sm:px-6 py-6">
    <div th:replace="~{::content}" class="bg-white rounded-lg shadow p-4 sm:p-6"></div>
</main>

<footer th:fragment="footer">
</footer>

</body>
</html>
