<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="en"
      th:lang="${#locale.toLanguageTag()}">
<head>
    <th:block th:insert="~{views/layout :: head}"/>

    <title>Conversation Room</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/script/conversation.js"></script>
    <script>
        // Utility to get conversation message container
        const getConversationContainer = () => document.getElementById("conversation-message-list");

        // Observe the scroll loader and trigger HTMX request when it becomes visible
        const observeScrollLoader = (container) => {
            const loader = document.querySelector('#conversation-scroll-loader');
            if (!loader || !container || loader._observed) return;

            loader._observed = true; // Prevent duplicate observers
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const getUrl = loader.getAttribute("data-hx-get");
                        if (getUrl) {
                            loader.setAttribute("hx-get", getUrl); // Set actual hx-get
                            htmx.trigger(loader, 'revealed');       // Fire the request manually
                            observer.unobserve(loader);              // Stop observing this loader
                        }
                    }
                });
            }, {
                root: container,
                rootMargin: '0px',
                threshold: 0.1 // Trigger even with partial visibility
            });

            observer.observe(loader);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Establish connection immediately
            ensureConnected(() => {});

            // Scroll
            let previousScrollHeight = null;

            // Safety: disconnect on page unload
            window.addEventListener('beforeunload', disconnectAll);

            // Before sending HX request, save scroll height
            document.body.addEventListener("htmx:beforeRequest", (event) => {
                if (event.target.id === "conversation-scroll-loader") {
                    const container = getConversationContainer();
                    if (container) {
                        previousScrollHeight = container.scrollHeight;
                    }
                }
            });

            document.body.addEventListener("htmx:afterRequest", (event) => {
                const target = event.target;
                if (target.id === "conversation-scroll-loader") {
                    target.remove();
                }
            });

            // After content swap (e.g., conversation list), do scroll adjustments or observe new loaders
            document.body.addEventListener("htmx:afterSwap", (event) => {
                const container = getConversationContainer();

                // If panel gets removed or navigated away, fully disconnect
                if (event.target && event.target.id === 'conversation-panel') {
                    if (!document.getElementById('conversation-message-list')) {
                        disconnectAll();
                    }
                }

                // Scroll to bottom on initial load
                if (event.target.id === "conversation-message-list" && document.getElementById("initial-loader")) {
                    container.scrollTop = container.scrollHeight;
                    document.getElementById("initial-loader")?.remove();
                }

                // (Re-)observe scroll loader if needed
                if ((event.target.id === "conversation-scroll-loader" || event.target.id === "conversation-message-list") && container) {
                    observeScrollLoader(container);
                }

                // Message Send
                const input = document.getElementById("conversation-input");
                const sendBtn = document.getElementById("conversation-send-button");

                if (input && sendBtn) {
                    input.addEventListener("keydown", (event) => {
                        if (event.key === "Enter" && !event.shiftKey) {
                            event.preventDefault();
                            sendBtn.click();
                        }
                    });
                }
            });

            document.body.addEventListener('htmx:oobBeforeSwap', (e) => {
                // Before OOB swap of the panel: unsubscribe the previous room
                if (e.target && e.target.id === 'conversation-panel') {
                    unsubscribeCurrent();
                }
            });

            // Handle out-of-band swaps (conversation panel load or scroll restoration)
            document.body.addEventListener("htmx:oobAfterSwap", (event) => {
                if (event.target && event.target.id === 'conversation-panel') {
                    const panel = event.target;
                    const conversationId = panel.getAttribute('data-conversation-id');
                    subscribeConversation(conversationId);

                    // Optional: wire send button if present (not a resubscribe button)
                    const sendButton = panel.querySelector('#conversation-send-button');
                    if (sendButton) {
                        sendButton.addEventListener('click', sendMessage);
                    }
                }

                // Restore scroll position after loading previous messages
                if (event.target.id === "conversation-scroll-loader" && previousScrollHeight !== null) {
                    const container = getConversationContainer();
                    if (container) {
                        const newScrollHeight = container.scrollHeight;
                        container.scrollTop += newScrollHeight - previousScrollHeight;
                    }
                    previousScrollHeight = null;
                    event.target.remove(); // Remove used loader
                }
            });
        });
    </script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 antialiased">
<header th:replace="~{views/layout :: header}"></header>

<main th:fragment="content"
      class="flex-grow flex flex-col items-center py-6 sm:py-8">
    <section class="z-10 border rounded-xl bg-white shadow-sm max-w-5xl w-full h-[80vh] text-sm overflow-hidden">
        <div class="flex flex-col lg:flex-row w-full h-full min-h-0">
            <div class="w-full lg:w-80 shrink-0 border-b lg:border-b-0 lg:border-r bg-gray-50/60 h-full">
                <div class="p-4 flex flex-col h-full overflow-y-auto">
                    <div id="user-menu"></div>
                    <div hidden="hidden"
                         id="refresh-user-menu"
                         hx-trigger="load, refresh:refresh-user-menu from:body"
                         hx-get="/hx/conversations/menu"
                         hx-swap="none"></div>

                    <aside class="sidebar sticky top-0 z-10 bg-gray-50/60 pb-2">
                        <nav class="flex items-stretch rounded-2xl border border-gray-200 bg-white/90 backdrop-blur-sm shadow-sm px-1 py-1 divide-x divide-gray-200">
                            <!-- Search Friends -->
                            <button type="button"
                                    hx-get="/hx/conversations/friends/search/modal"
                                    hx-swap="none"
                                    aria-label="Search Friends"
                                    class="group relative flex-1 flex flex-col items-center justify-center gap-1 py-1.5 px-2 hover:bg-gray-50 rounded-xl transition">
                                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm text-gray-700 group-hover:text-blue-600 group-hover:border-blue-300 transition-colors">
                                <!-- magnifying-glass -->
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="w-5 h-5"
                                     viewBox="0 0 24 24"
                                     fill="none"
                                     stroke="currentColor"
                                     stroke-width="1.8">
                                    <circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4.3-4.3"></path>
                                </svg>
                              </span>
                                <span class="text-[11px] leading-none text-gray-500 group-hover:text-gray-900">Friends</span>
                                <span class="pointer-events-none absolute left-2 right-2 bottom-0 h-0.5 bg-blue-500 rounded-full scale-x-0 group-hover:scale-x-100 transition-transform duration-200 origin-center"></span>
                            </button>

                            <!-- Search Groups -->
                            <button type="button"
                                    hx-get="/hx/conversations/groups/search/modal"
                                    hx-swap="none"
                                    aria-label="Search Groups"
                                    class="group relative flex-1 flex flex-col items-center justify-center gap-1 py-1.5 px-2 hover:bg-gray-50 rounded-xl transition">
                                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm text-gray-700 group-hover:text-blue-600 group-hover:border-blue-300 transition-colors">
                                    <!-- users -->
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="w-5 h-5"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="1.8">
                                        <path d="M16 11a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z"></path>
                                        <path d="M7 12a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z"></path>
                                        <path d="M7 15a5 5 0 0 0-5 5"></path>
                                        <path d="M16 14a5 5 0 0 1 5 5"></path>
                                    </svg>
                                </span>
                                <span class="text-[11px] leading-none text-gray-500 group-hover:text-gray-900">Groups</span>
                                <span class="pointer-events-none absolute left-2 right-2 bottom-0 h-0.5 bg-blue-500 rounded-full scale-x-0 group-hover:scale-x-100 transition-transform duration-200 origin-center"></span>
                            </button>

                            <!-- Create Group -->
                            <button type="button"
                                    hx-get="/hx/conversations/groups/modal"
                                    hx-swap="none"
                                    aria-label="Create Group"
                                    class="group relative flex-1 flex flex-col items-center justify-center gap-1 py-1.5 px-2 hover:bg-gray-50 rounded-xl transition">
                                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm text-gray-700 group-hover:text-blue-600 group-hover:border-blue-300 transition-colors">
                                    <!-- user-plus -->
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="w-5 h-5"
                                         viewBox="0 0 24 24"
                                         fill="none" stroke="currentColor"
                                         stroke-width="1.8">
                                        <path d="M15 8a4 4 0 1 1-4-4 4 4 0 0 1 4 4Z"></path>
                                        <path d="M3 20a7 7 0 0 1 14 0"></path>
                                        <path d="M19 8v6"></path>
                                        <path d="M22 11h-6"></path>
                                    </svg>
                                </span>
                                <span class="text-[11px] leading-none text-gray-500 group-hover:text-gray-900">New Group</span>
                                <span class="pointer-events-none absolute left-2 right-2 bottom-0 h-0.5 bg-blue-500 rounded-full scale-x-0 group-hover:scale-x-100 transition-transform duration-200 origin-center"></span>
                            </button>
                        </nav>
                    </aside>

                    <!-- Sidebar secondary block: header (buttons) + scrollable content -->
                    <section aria-label="Sidebar secondary menu"
                             class="mt-2 flex-1 min-h-0 flex flex-col">
                        <div class="flex-1 min-h-0 rounded-2xl border border-gray-200 bg-white/90 backdrop-blur-sm shadow-sm overflow-hidden flex flex-col">
                            <div class="flex items-center justify-center gap-1 px-1 py-1 border-b border-gray-200">
                                <!-- Friends button -->
                                <button type="button"
                                        class="flex items-center justify-center gap-2 h-8 px-3 text-sm font-medium rounded-lg text-gray-700 hover:bg-gray-50 transition"
                                        title="Friends"
                                        hx-get="/hx/conversations/friends"
                                        hx-swap="none"
                                        hx-indicator="#sidebar-secondary-loading">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="w-4 h-4 text-gray-700 group-hover:text-blue-600"
                                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                                        <path d="M16 11a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z"></path>
                                        <path d="M7 12a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z"></path>
                                        <path d="M7 15a5 5 0 0 0-5 5"></path>
                                        <path d="M16 14a5 5 0 0 1 5 5"></path>
                                    </svg>
                                    <span class="text-xs">Friends</span>
                                </button>

                                <!-- Conversations button -->
                                <button type="button"
                                        class="flex items-center justify-center gap-2 h-8 px-3 text-sm font-medium rounded-lg text-gray-700 hover:bg-gray-50 transition"
                                        title="Conversations"
                                        hx-get="/hx/conversations"
                                        hx-swap="none"
                                        hx-indicator="#sidebar-secondary-loading">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="w-4 h-4 text-gray-700 group-hover:text-blue-600"
                                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                                        <path d="M21 15a4 4 0 0 1-4 4H7l-4 3V5a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4Z"></path>
                                    </svg>
                                    <span class="text-xs">Conversations</span>
                                </button>

                                <!-- loading spinner -->
                                <div id="sidebar-secondary-loading"
                                     class="ml-auto mr-1 h-4 w-4 animate-spin rounded-full border-2 border-gray-300 border-t-transparent hidden"
                                     aria-hidden="true"></div>
                            </div>

                            <!-- scrollable content wrapper -->
                            <div id="sidebar-secondary-content-wrap"
                                 class="flex-1 min-h-0">
                                <div hidden="hidden"
                                     id="refresh-friend-list"
                                     hx-trigger="load"
                                     hx-get="/hx/conversations/friends"
                                     hx-swap="none"></div>

                                <div id="sidebar-secondary-content">
                                    <div class="flex items-center justify-center h-full text-xs text-gray-400">
                                        No content loaded
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Conversation Panel -->
            <div id="conversation-panel"
                 class="flex-1 h-full min-h-0 overflow-hidden flex items-center justify-center">
                <!-- Empty state -->
                <div class="text-center max-w-md px-6">
                    <div class="mx-auto mb-6 inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-blue-50 border border-blue-100 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-blue-500" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="1.6">
                            <path d="M21 12a9 9 0 1 1-9-9"></path>
                            <path d="M8 12h8M8 9h5M8 15h6"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Welcome</h2>
                    <p class="mt-2 text-sm text-gray-500">Select a conversation from the list to start chatting</p>
                    <p class="mt-1 text-xs text-gray-400">Your messages will appear here</p>
                </div>
            </div>
        </div>
    </section>
</main>

<footer th:replace="~{views/layout :: footer}"></footer>
</body>
</html>
